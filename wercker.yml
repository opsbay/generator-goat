box: wercker/nodejs

# Build definition
build:
  # The steps that will be executed on build
  steps:
    - npm-install
    - npm-test

    - script:
        name: Coverall setup
        code: |
          export COVERALLS_SERVICE_NAME=wercker
          export COVERALLS_REPO_TOKEN=$COVERALLS_TOKEN
#          export COVERALLS_GIT_COMMIT=$WERCKER_GIT_COMMIT
#          export COVERALLS_SERVICE_JOB_ID=$WERCKER_BUILD_ID
          export COVERALLS_GIT_BRANCH=$WERCKER_GIT_BRANCH
    - scripts:
        name: Coveralls.io
        code: |
          NODE_ENV=test istanbul cover ./node_modules/mocha/bin/_mocha --report lcovonly -- -R spec && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage


deploy:
  steps:
    - script:
        name: Add npm user
        code: |
          touch ~/.npmrc
          echo //registry.npmjs.org/:_password=$NPM_PASS >> ~/.npmrc
          echo //registry.npmjs.org/:username=$NPM_USER >> ~/.npmrc
          echo //registry.npmjs.org/:username=$NPM_EMAIL >> ~/.npmrc
          echo //registry.npmjs.org/:always-auth=false >> ~/.npmrc

    - script:
        name: Publish to npm
        code: |
          npm publish .
